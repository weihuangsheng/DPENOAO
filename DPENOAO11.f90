!-------------------------------------------------------------------------------------------------
!		Subroutine for calculating the positive cell-interface flux using DPENO-AO11 scheme
!-------------------------------------------------------------------------------------------------
module DPENOAO11
	implicit none
	integer:: k, r
	integer:: klist(2:10)
	real(Kind=8):: delta(-4:50)
	real(Kind=8):: alpha(2,2:10)
	real(Kind=8):: dp(36)
	real(Kind=8):: Max_alpha
	integer, parameter :: p=11
	integer, parameter :: kp=(p-1)/2
	integer, parameter :: p_delta(10) = [0, 9, 17, 24, 30, 35, 39, 42, 44, 45]
	integer, parameter :: p_c(11) = [1, 2, 4, 7, 11, 16, 21, 25, 28, 30, 31]
	real(Kind=8), parameter:: kc=3.1415926535897932385/2.
	real(Kind=8), parameter:: sin_r_kc_half(1:p)=(/(sin(kc/2.)**(1-r),r=1,p,1)/)
	real(kind=8), parameter :: c(36) = sqrt([ &
	1./12., &
	1./45., 1./45., &
	59./6048., 17./6048., 59./6048., &
	1213./226800., 163./226800., 163./226800., 1213./226800., &
	22789./6842880., 8807./34214400., 4121./34214400., 8807./34214400., 22789./6842880., &
	1438363./638512875., 71998./638512875., 38891./1277025750., 38891./1277025750., 71998./638512875., 1438363./638512875., &
	147813331./2615348736000., 5187401./523069747200., 14981203./2615348736000., 5187401./523069747200., 147813331./2615348736000., &
	3200237./833642409600., 240391./166728481920., 240391./166728481920., 3200237./833642409600., &
	343904352011./774105184419840000., 44734915633./154821036883968000., 343904352011./774105184419840000., &
	298690042979./4116213602701200000., 298690042979./4116213602701200000., &
	2709481823947123./178975500499972915200000.])
	real(Kind=8), parameter:: a(-5:5, -5:0, 0:5)=reshape(&
	[-10./60.,    62./60.,     -163./60.,    237./60.,     -213./60.,    147./60.,      0.,            0.,           0.,          0.,           0.,         &
	0.,          12./60.,     -63./60.,     137./60.,     -163./60.,    137./60.,      0.,            0.,           0.,          0.,           0.,         &
	0.,          0.,          -3./12.,      13./12.,      -23./12.,     25./12.,       0.,            0.,           0.,          0.,           0.,         &
	0.,          0.,          0.,           2./6.,        -7./6.,       11./6.,        0.,            0.,           0.,          0.,           0.,         &
	0.,          0.,          0.,           0.,           -1./2.,       3./2.,         0.,            0.,           0.,          0.,           0.,         &
	0.,          0.,          0.,           0.,           0.,           1./1.,         0.,            0.,           0.,          0.,           0.,         &
	-10./420.,   74./420.,    -241./420.,   459./420.,    -591./420.,   669./420.,     60./420.,      0.,           0.,          0.,           0.,         &
	0.,          2./60.,      -13./60.,     37./60.,      -63./60.,     87./60.,       10./60.,       0.,           0.,          0.,           0.,         &
	0.,          0.,          -3./60.,      17./60.,      -43./60.,     77./60.,       12./60.,       0.,           0.,          0.,           0.,         &
	0.,          0.,          0.,           1./12.,       -5./12.,      13./12.,       3./12.,        0.,           0.,          0.,           0.,         &
	0.,          0.,          0.,           0.,           -1./6.,       5./6.,         2./6.,         0.,           0.,          0.,           0.,         &
	0.,          0.,          0.,           0.,           0.,           1./2.,         1./2.,         0.,           0.,          0.,           0.,         &
	-5./840.,    43./840.,    -167./840.,   393./840.,    -657./840.,   1023./840.,    225./840.,     -15./840.,    0.,          0.,           0.,         &
	0.,          4./420.,     -31./420.,    109./420.,    -241./420.,   459./420.,     130./420.,     -10./420.,    0.,          0.,           0.,         &
	0.,          0.,          -1./60.,      7./60.,       -23./60.,     57./60.,       22./60.,       -2./60.,      0.,          0.,           0.,         &
	0.,          0.,          0.,           2./60.,       -13./60.,     47./60.,       27./60.,       -3./60.,      0.,          0.,           0.,         &
	0.,          0.,          0.,           0.,           -1./12.,      7./12.,        7./12.,        -1./12.,      0.,          0.,           0.,         &
	0.,          0.,          0.,           0.,           0.,           2./6.,         5./6.,         -1./6.,       0.,          0.,           0.,         &
	-5./2520.,   49./2520.,   -221./2520.,  619./2520.,   -1271./2520., 2509./2520.,   955./2520.,    -125./2520.,  10./2520.,   0.,           0.,         &
	0.,          3./840.,     -27./840.,    113./840.,    -307./840.,   743./840.,     365./840.,     -55./840.,    5./840.,     0.,           0.,         &
	0.,          0.,          -3./420.,     25./420.,     -101./420.,   319./420.,     214./420.,     -38./420.,    4./420.,     0.,           0.,         &
	0.,          0.,          0.,           1./60.,       -8./60.,      37./60.,       37./60.,       -8./60.,      1./60.,      0.,           0.,         &
	0.,          0.,          0.,           0.,           -3./60.,      27./60.,       47./60.,       -13./60.,     2./60.,      0.,           0.,         &
	0.,          0.,          0.,           0.,           0.,           3./12.,       13./12.,       -5./12.,       1./12.,      0.,           0.,         &
	-2./2520.,   22./2520.,   -113./2520.,  367./2520.,   -893./2520.,  2131./2520.,   1207./2520.,   -233./2520.,  37./2520.,   -3./2520.,    0.,         &
	0.,          4./2520.,    -41./2520.,   199./2520.,   -641./2520.,  1879./2520.,   1375./2520.,   -305./2520.,  55./2520.,   -5./2520.,    0.,         &
	0.,          0.,          -3./840.,    29./840.,      -139./840.,   533./840.,     533./840.,     -139./840.,   29./840.,    -3./840.,     0.,         &
	0.,          0.,          0.,          4./420.,       -38./420.,    214./420.,     319./420.,     -101./420.,   25./420.,    -3./420.,     0.,         &
	0.,          0.,          0.,          0.,            -2./60.,      22./60.,       57./60.,       -23./60.,     7./60.,      -1./60.,      0.,         &
	0.,          0.,          0.,          0.,            0.,           12./60.,       77./60.,       -43./60.,     17./60.,     -3./60.,      0.,         &
	-10./27720., 122./27720., -703./27720., 2597./27720., -7303./27720.,20417./27720., 15797./27720., -4003./27720.,947./27720., -153./27720., 12./27720., &
	0.,          2./2520.,    -23./2520.,   127./2520.,   -473./2520.,  1627./2520.,   1627./2520.,   -473./2520.,  127./2520.,  -23./2520.,   2./2520.,   &
	0.,          0.,          -5./2520.,    55./2520.,    -305./2520.,  1375./2520.,   1879./2520.,   -641./2520.,  199./2520.,  -41./2520.,   4./2520.,   &
	0.,          0.,          0.,           5./840.,      -55./840.,    365./840.,     743./840.,     -307./840.,   113./840.,   -27./840.,    3./840.,    &
	0.,          0.,          0.,           0.,           -10./420.,    130./420.,     459./420.,     -241./420.,   109./420.,   -31./420.,    4./420.,    &
	0.,          0.,          0.,           0.,           0.,           10./60.,       87./60.,       -63./60.,     37./60.,     -13./60.,     2./60.      &
	],[11,6,6])
end module DPENOAO11

subroutine flux_DPENOAO_11_P(f_j, numericalFlux)
	use DPENOAO11
	implicit none
	real(Kind=8), intent(in) :: f_j(-kp:kp)
	real(Kind=8), intent(out) :: numericalFlux
	integer :: Lp,Rp

!-------------------------------------------------------
	! Init delta
	do k = 1-kp, kp
		delta(k) = f_j(k) - f_j(k-1)
	end do
	
!-------------------------------------------------------
	! Forward pass procedure
	do r = 1, kp
		do k = r-kp, 0
			delta(p_delta(r+1)+k+1) = delta(p_delta(r)+k+1) - delta(p_delta(r)+k)
		end do
		dp(p_c(r+1)) = dp(p_c(r)) + c(p_c(r))*abs(delta(p_delta(r)))
		do k= 1, r-1
			delta(p_delta(r+1)+k+1) = delta(p_delta(r)+k+1) - delta(p_delta(r)+k)
			dp(p_c(r+1)+k) = min(dp(p_c(r)+k)   + c(p_c(r)+k)  *abs(delta(p_delta(r)+k)), &
								 dp(p_c(r)+k-1) + c(p_c(r)+k-1)*abs(delta(p_delta(r)+k)))
		enddo
		delta(p_delta(r+1)+r+1) = delta(p_delta(r)+r+1) - delta(p_delta(r)+r)
		dp(p_c(r+1)+r) = dp(p_c(r)+r-1) + c(p_c(r)+r-1)*abs(delta(p_delta(r)+r))
		do k = r+1, kp-1
			delta(p_delta(r+1)+k+1) = delta(p_delta(r)+k+1) - delta(p_delta(r)+k)
		end do
	end do
	
	do r = kp+1, 2*kp-1
		do k = r-kp, kp-1
			delta(p_delta(r+1)+k+1) = delta(p_delta(r)+k+1) - delta(p_delta(r)+k)
			dp(p_c(r+1)+k) = min(dp(p_c(r)+k)   + c(p_c(r)+k)  *abs(delta(p_delta(r)+k)), &
								 dp(p_c(r)+k-1) + c(p_c(r)+k-1)*abs(delta(p_delta(r)+k)))
		end do
		dp(p_c(r+1)+kp) = min(dp(p_c(r)+kp)   + c(p_c(r)+kp)  *abs(delta(p_delta(r)+kp)), &
							  dp(p_c(r)+kp-1) + c(p_c(r)+kp-1)*abs(delta(p_delta(r)+kp)))
	end do

!-------------------------------------------------------
	! Backward pass procedure
	if(dp(p_c(p-1)+kp) .lt. dp(p_c(p-1)+kp-1))then
		klist(p-1)=kp
		alpha(1,p-1)=c(p_c(p-1)+kp)*abs(delta(p_delta(p-1)+kp))*sin_r_kc_half(p-1)
	else
		klist(p-1)=kp-1
		alpha(1,p-1)=c(p_c(p-1)+kp)*abs(delta(p_delta(p-1)+kp))*sin_r_kc_half(p-1)
	endif
	
	if (dp(p_c(p-2)+klist(p-1)-1)+c(p_c(p-2)+klist(p-1)-1)*abs(delta(p_delta(p-2)+klist(p-1))) .gt.  &
		dp(p_c(p-1)+klist(p-1)))then
		klist(p-2)=klist(p-1)
		alpha(1,p-2)=(dp(p_c(p-1)+klist(p-1))-dp(p_c(p-2)+klist(p-2)))*sin_r_kc_half(p-2)
		alpha(2,p-2)=maxval(alpha(1,p-2:p-1))
	else
		klist(p-2)=klist(p-1)-1
		alpha(1,p-2)=(dp(p_c(p-1)+klist(p-1))-dp(p_c(p-2)+klist(p-2)))*sin_r_kc_half(p-2)
		alpha(2,p-2)=maxval(alpha(1,p-2:p-1))
	endif

	do r=p-2,kp+2,-1
		if (dp(p_c(r-1)+klist(r)-1)+c(p_c(r-1)+klist(r)-1)*abs(delta(p_delta(r-1)+klist(r))) .gt.  &
			dp(p_c(r)+klist(r)))then
            klist(r-1)=klist(r)
			alpha(1,r-1)=(dp(p_c(r)+klist(r))-dp(p_c(r-1)+klist(r-1)))*sin_r_kc_half(r-1)
			alpha(2,r-1)=min(maxval(alpha(1,r-1:r)),alpha(2,r))
		else
            klist(r-1)=klist(r)-1
			alpha(1,r-1)=(dp(p_c(r)+klist(r))-dp(p_c(r-1)+klist(r-1)))*sin_r_kc_half(r-1)
			alpha(2,r-1)=min(maxval(alpha(1,r-1:r)),alpha(2,r))
		endif
	enddo

	do r=kp+1,3,-1
		if (klist(r) == 0)then
            klist(r-1)=klist(r)
			alpha(1,r-1)=(dp(p_c(r)+klist(r))-dp(p_c(r-1)+klist(r-1)))*sin_r_kc_half(r-1)
			alpha(2,r-1)=min(maxval(alpha(1,r-1:r)),alpha(2,r))
		elseif (klist(r) == r-1)then
            klist(r-1)=klist(r)-1
			alpha(1,r-1)=(dp(p_c(r)+klist(r))-dp(p_c(r-1)+klist(r-1)))*sin_r_kc_half(r-1)
			alpha(2,r-1)=min(maxval(alpha(1,r-1:r)),alpha(2,r))
		elseif (dp(p_c(r-1)+klist(r)-1)+c(p_c(r-1)+klist(r)-1)*abs(delta(p_delta(r-1)+klist(r))) .gt.  &
				dp(p_c(r)+klist(r)))then
            klist(r-1)=klist(r)
			alpha(1,r-1)=(dp(p_c(r)+klist(r))-dp(p_c(r-1)+klist(r-1)))*sin_r_kc_half(r-1)
			alpha(2,r-1)=min(maxval(alpha(1,r-1:r)),alpha(2,r))
		else
            klist(r-1)=klist(r)-1
			alpha(1,r-1)=(dp(p_c(r)+klist(r))-dp(p_c(r-1)+klist(r-1)))*sin_r_kc_half(r-1)
			alpha(2,r-1)=min(maxval(alpha(1,r-1:r)),alpha(2,r))
		endif
	enddo
	
! -------------------------------------------------------
	! Compute the numerical flux with adaptive order
	Max_alpha=dp(p_c(2)+klist(2))
	do r=3,p-1
		Max_alpha=max(Max_alpha,alpha(1,r-1))
		if(alpha(2,r-1) .gt. Max_alpha) then
			Rp=klist(r); Lp=Rp+1-r
			numericalFlux=sum(a(Lp:Rp,Lp,Rp)*f_j(Lp:Rp))
			return
		endif
	enddo
	numericalFlux=sum(a(-kp:kp,-kp,kp)*f_j(-kp:kp))
end
